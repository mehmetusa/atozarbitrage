"use strict";(()=>{var a={};a.id=6897,a.ids=[6897],a.modules={830:(a,b,c)=>{c.d(b,{A:()=>h});var d=c(6037),e=c.n(d);let f=process.env.MONGO_URL;if(!f)throw Error("Please define the MONGO_URL environment variable inside .env.local");let g=global.mongoose;g||(g=global.mongoose={conn:null,promise:null});let h=async function(){return g.conn||(g.promise||(g.promise=e().connect(f,{bufferCommands:!1}).then(a=>a)),g.conn=await g.promise),g.conn}},1572:a=>{a.exports=require("nodemailer")},3873:a=>{a.exports=require("path")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5644:a=>{a.exports=require("micro")},6037:a=>{a.exports=require("mongoose")},6524:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>k,default:()=>j});var e=c(5644),f=c(9767),g=c(830);!function(){var a=Error("Cannot find module '../../../models/Order'");throw a.code="MODULE_NOT_FOUND",a}();var h=c(8775),i=a([f]);f=(i.then?(await i)():i)[0];let k={api:{bodyParser:!1}},l=new f.default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-06-20"});async function j(a,b){let c;if("POST"!==a.method)return b.status(405).end("Method Not Allowed");let d=await (0,e.buffer)(a),f=a.headers["stripe-signature"];try{c=l.webhooks.constructEvent(d,f,process.env.STRIPE_WEBHOOK_SECRET)}catch(a){return console.error("âŒ Webhook signature verification failed:",a.message),b.status(400).send(`Webhook Error: ${a.message}`)}if(await (0,g.A)(),"checkout.session.completed"===c.type){let a=c.data.object,d=a.metadata||{};try{let c=await Object(function(){var a=Error("Cannot find module '../../../models/Order'");throw a.code="MODULE_NOT_FOUND",a}())({stripeId:a.id});if(c)return console.log(`âš ï¸ Order with stripeId ${a.id} already exists`),b.status(200).json({received:!0});d.displayId&&(c=await Object(function(){var a=Error("Cannot find module '../../../models/Order'");throw a.code="MODULE_NOT_FOUND",a}())({displayId:d.displayId},{stripeId:a.id,status:1,paymentStatus:"Paid"},{new:!0})),c||(c=await Object(function(){var a=Error("Cannot find module '../../../models/Order'");throw a.code="MODULE_NOT_FOUND",a}())({stripeId:a.id,displayId:d.displayId,userId:d.userId||null,items:d.items?JSON.parse(d.items):[],customer:{name:d.customerName,email:d.customerEmail,phone:d.customerPhone,address:{street:d.street,city:d.city,state:d.state,zip:d.zip,country:d.country}},subtotal:parseFloat(d.subtotal||0),discount:parseFloat(d.discount||0),tax:parseFloat(d.tax||0),shippingFee:parseFloat(d.shippingFee||0),total:parseFloat(d.total||0),method:1,deliveryDate:d.deliveryDate?new Date(d.deliveryDate):null,deliverySlot:d.deliverySlot||"",notes:d.notes||"",usedCouponCode:d.couponCode||"",status:1,paymentStatus:"Paid"}));try{await (0,h.A)({customerEmail:c.customer.email,order:c}),await (0,h.A)(c,"iAmazon@gmail.com"),console.log(`ðŸ“§ Invoice sent to ${c.customer.email}`)}catch(a){console.error("âš ï¸ Failed to send invoice:",a)}try{await l.paymentIntents.update(a.payment_intent,{receipt_email:c.customer.email})}catch(a){console.error("âš ï¸ Failed to update payment intent:",a.message)}}catch(a){return console.error("âŒ Error processing Stripe session:",a),b.status(500).json({error:"Webhook handler failed"})}}return b.status(200).json({received:!0})}d()}catch(a){d(a)}})},8775:(a,b,c)=>{c.d(b,{A:()=>l});let d=require("pdfkit");var e=c.n(d),f=c(1572),g=c.n(f),h=c(3873),i=c.n(h),j=c(9021),k=c.n(j);async function l(a,b){try{let c=new(e())({size:"A4",margin:50}),d=[];c.on("data",d.push.bind(d));let f=new Promise(a=>{c.on("end",()=>a(Buffer.concat(d)))}),h=i().join(process.cwd(),"public","img","Amazon.png");k().existsSync(h)&&c.image(h,50,45,{width:100}),c.moveDown(2),c.fontSize(20).text("Amazon Arbirtage",{align:"center"}),c.moveDown(),c.fontSize(16).text(`Invoice #${a.displayId}`),c.text(`Date: ${new Date(a.createdAt).toLocaleDateString()}`),c.moveDown(),c.fontSize(14).text("Customer Details:"),c.text(`Name: ${a.customer.name}`),c.text(`Email: ${a.customer.email}`),c.text(`Phone: ${a.customer.phone}`);let j=a.customer.address;c.text(`Address: ${j.street}, ${j.city}, ${j.state}, ${j.zip}, ${j.country}`),c.moveDown(),c.fontSize(14).text("Delivery Details:"),c.text(`Delivery Date: ${a.deliveryDate}`),c.text(`Delivery Slot: ${a.deliverySlot}`),c.moveDown(),c.fontSize(14).text("Payment Method:"),c.text(1===a.method?"Stripe":"Cash on Delivery"),c.moveDown(),a.notes&&(c.fontSize(14).text("Order Notes:"),c.text(a.notes),c.moveDown()),c.fontSize(14).text("Items:",{underline:!0}),a.items.forEach((a,b)=>{c.text(`${b+1}. ${a.title} x ${a.quantity} - $${(a.price*a.quantity).toFixed(2)}`),a.notes&&c.text(`   Item Notes: ${a.notes}`),a.extras?.length&&a.extras.forEach(a=>{c.text(`   Extra: ${a.text} - $${a.price.toFixed(2)}`)})}),c.moveDown(),c.text(`Subtotal: $${a.subtotal.toFixed(2)}`),a.discount&&c.text(`Discount: -$${a.discount.toFixed(2)}`),c.text(`Tax: $${a.tax.toFixed(2)}`),c.text(`Shipping: $${a.shippingFee?.toFixed(2)||0}`),c.moveDown(),c.fontSize(16).text(`Total: $${a.total.toFixed(2)}`,{align:"right"}),c.end();let l=await f;console.log("SMTP Config",{host:process.env.SMTP_HOST,port:process.env.SMTP_PORT,user:process.env.SMTP_USER,passLength:process.env.SMTP_PASS?.length});let m=g().createTransport({host:process.env.SMTP_HOST,port:parseInt(process.env.SMTP_PORT||"587"),secure:!1,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}});return await m.sendMail({from:`"Amazon Arbirtage" <${process.env.SMTP_USER}>`,to:b,subject:`Your Invoice #${a.displayId}`,text:`Hello ${a.customer.name},

Thank you for your order! Your invoice is attached.

Total: $${a.total}
Delivery: ${a.deliveryDate} (${a.deliverySlot})

- Amazon Arbirtage`,attachments:[{filename:`Invoice-${a.displayId}.pdf`,content:l,contentType:"application/pdf"}]}),console.log("Invoice sent successfully to",b),!0}catch(a){return console.error("sendInvoice error:",a),!1}}},9021:a=>{a.exports=require("fs")},9702:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n,handler:()=>m});var e=c(9046),f=c(8667),g=c(3480),h=c(6435),i=c(6524),j=c(8112),k=c(6385),l=a([i]);i=(l.then?(await l)():l)[0];let n=(0,h.M)(i,"default"),o=(0,h.M)(i,"config"),p=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/stripe/webhooks",pathname:"/api/stripe/webhooks",bundlePath:"",filename:""},userland:i,distDir:".next",relativeProjectDir:""});async function m(a,b,c){let d=await p.prepare(a,b,{srcPage:"/api/stripe/webhooks"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,j.getTracer)(),e=d.getActiveScopeSpan(),l=p.instrumentationOnRequestError.bind(p),m=async e=>p.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:p.isDev,page:"/api/stripe/webhooks",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>l(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await m(e):await d.withPropagatedContext(a.headers,()=>d.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},m))}catch(a){if(p.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})},9767:a=>{a.exports=import("stripe")}};var b=require("../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[7169],()=>b(b.s=9702));module.exports=c})();